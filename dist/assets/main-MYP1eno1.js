(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))n(o);new MutationObserver(o=>{for(const s of o)if(s.type==="childList")for(const a of s.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&n(a)}).observe(document,{childList:!0,subtree:!0});function r(o){const s={};return o.integrity&&(s.integrity=o.integrity),o.referrerPolicy&&(s.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?s.credentials="include":o.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function n(o){if(o.ep)return;o.ep=!0;const s=r(o);fetch(o.href,s)}})();var $=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ot(t){if(t.__esModule)return t;var e=t.default;if(typeof e=="function"){var r=function n(){return this instanceof n?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};r.prototype=e.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(t).forEach(function(n){var o=Object.getOwnPropertyDescriptor(t,n);Object.defineProperty(r,n,o.get?o:{enumerable:!0,get:function(){return t[n]}})}),r}var _={},me={},ee={},j={},te={},re={},st=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},M=st();const at=M.fetch,it=M.fetch.bind(M),ct=M.Headers,lt=M.Request,dt=M.Response,ut=Object.freeze(Object.defineProperty({__proto__:null,Headers:ct,Request:lt,Response:dt,default:it,fetch:at},Symbol.toStringTag,{value:"Module"})),mt=ot(ut);var ne={};Object.defineProperty(ne,"__esModule",{value:!0});let ht=class extends Error{constructor(e){super(e.message),this.name="PostgrestError",this.details=e.details,this.hint=e.hint,this.code=e.code}};ne.default=ht;var Te=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(re,"__esModule",{value:!0});const pt=Te(mt),ft=Te(ne);let gt=class{constructor(e){var r,n;this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=new Headers(e.headers),this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=(r=e.shouldThrowOnError)!==null&&r!==void 0?r:!1,this.signal=e.signal,this.isMaybeSingle=(n=e.isMaybeSingle)!==null&&n!==void 0?n:!1,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=pt.default:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}setHeader(e,r){return this.headers=new Headers(this.headers),this.headers.set(e,r),this}then(e,r){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers.set("Accept-Profile",this.schema):this.headers.set("Content-Profile",this.schema)),this.method!=="GET"&&this.method!=="HEAD"&&this.headers.set("Content-Type","application/json");const n=this.fetch;let o=n(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async s=>{var a,d,l,u;let c=null,p=null,y=null,w=s.status,E=s.statusText;if(s.ok){if(this.method!=="HEAD"){const H=await s.text();H===""||(this.headers.get("Accept")==="text/csv"||this.headers.get("Accept")&&(!((a=this.headers.get("Accept"))===null||a===void 0)&&a.includes("application/vnd.pgrst.plan+text"))?p=H:p=JSON.parse(H))}const k=(d=this.headers.get("Prefer"))===null||d===void 0?void 0:d.match(/count=(exact|planned|estimated)/),F=(l=s.headers.get("content-range"))===null||l===void 0?void 0:l.split("/");k&&F&&F.length>1&&(y=parseInt(F[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(p)&&(p.length>1?(c={code:"PGRST116",details:`Results contain ${p.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},p=null,y=null,w=406,E="Not Acceptable"):p.length===1?p=p[0]:p=null)}else{const k=await s.text();try{c=JSON.parse(k),Array.isArray(c)&&s.status===404&&(p=[],c=null,w=200,E="OK")}catch{s.status===404&&k===""?(w=204,E="No Content"):c={message:k}}if(c&&this.isMaybeSingle&&(!((u=c==null?void 0:c.details)===null||u===void 0)&&u.includes("0 rows"))&&(c=null,w=200,E="OK"),c&&this.shouldThrowOnError)throw new ft.default(c)}return{error:c,data:p,count:y,status:w,statusText:E}});return this.shouldThrowOnError||(o=o.catch(s=>{var a,d,l;return{error:{message:`${(a=s==null?void 0:s.name)!==null&&a!==void 0?a:"FetchError"}: ${s==null?void 0:s.message}`,details:`${(d=s==null?void 0:s.stack)!==null&&d!==void 0?d:""}`,hint:"",code:`${(l=s==null?void 0:s.code)!==null&&l!==void 0?l:""}`},data:null,count:null,status:0,statusText:""}})),o.then(e,r)}returns(){return this}overrideTypes(){return this}};re.default=gt;var yt=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(te,"__esModule",{value:!0});const vt=yt(re);let wt=class extends vt.default{select(e){let r=!1;const n=(e??"*").split("").map(o=>/\s/.test(o)&&!r?"":(o==='"'&&(r=!r),o)).join("");return this.url.searchParams.set("select",n),this.headers.append("Prefer","return=representation"),this}order(e,{ascending:r=!0,nullsFirst:n,foreignTable:o,referencedTable:s=o}={}){const a=s?`${s}.order`:"order",d=this.url.searchParams.get(a);return this.url.searchParams.set(a,`${d?`${d},`:""}${e}.${r?"asc":"desc"}${n===void 0?"":n?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:r,referencedTable:n=r}={}){const o=typeof n>"u"?"limit":`${n}.limit`;return this.url.searchParams.set(o,`${e}`),this}range(e,r,{foreignTable:n,referencedTable:o=n}={}){const s=typeof o>"u"?"offset":`${o}.offset`,a=typeof o>"u"?"limit":`${o}.limit`;return this.url.searchParams.set(s,`${e}`),this.url.searchParams.set(a,`${r-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.set("Accept","application/vnd.pgrst.object+json"),this}maybeSingle(){return this.method==="GET"?this.headers.set("Accept","application/json"):this.headers.set("Accept","application/vnd.pgrst.object+json"),this.isMaybeSingle=!0,this}csv(){return this.headers.set("Accept","text/csv"),this}geojson(){return this.headers.set("Accept","application/geo+json"),this}explain({analyze:e=!1,verbose:r=!1,settings:n=!1,buffers:o=!1,wal:s=!1,format:a="text"}={}){var d;const l=[e?"analyze":null,r?"verbose":null,n?"settings":null,o?"buffers":null,s?"wal":null].filter(Boolean).join("|"),u=(d=this.headers.get("Accept"))!==null&&d!==void 0?d:"application/json";return this.headers.set("Accept",`application/vnd.pgrst.plan+${a}; for="${u}"; options=${l};`),a==="json"?this:this}rollback(){return this.headers.append("Prefer","tx=rollback"),this}returns(){return this}maxAffected(e){return this.headers.append("Prefer","handling=strict"),this.headers.append("Prefer",`max-affected=${e}`),this}};te.default=wt;var Et=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(j,"__esModule",{value:!0});const _t=Et(te);let bt=class extends _t.default{eq(e,r){return this.url.searchParams.append(e,`eq.${r}`),this}neq(e,r){return this.url.searchParams.append(e,`neq.${r}`),this}gt(e,r){return this.url.searchParams.append(e,`gt.${r}`),this}gte(e,r){return this.url.searchParams.append(e,`gte.${r}`),this}lt(e,r){return this.url.searchParams.append(e,`lt.${r}`),this}lte(e,r){return this.url.searchParams.append(e,`lte.${r}`),this}like(e,r){return this.url.searchParams.append(e,`like.${r}`),this}likeAllOf(e,r){return this.url.searchParams.append(e,`like(all).{${r.join(",")}}`),this}likeAnyOf(e,r){return this.url.searchParams.append(e,`like(any).{${r.join(",")}}`),this}ilike(e,r){return this.url.searchParams.append(e,`ilike.${r}`),this}ilikeAllOf(e,r){return this.url.searchParams.append(e,`ilike(all).{${r.join(",")}}`),this}ilikeAnyOf(e,r){return this.url.searchParams.append(e,`ilike(any).{${r.join(",")}}`),this}is(e,r){return this.url.searchParams.append(e,`is.${r}`),this}in(e,r){const n=Array.from(new Set(r)).map(o=>typeof o=="string"&&new RegExp("[,()]").test(o)?`"${o}"`:`${o}`).join(",");return this.url.searchParams.append(e,`in.(${n})`),this}contains(e,r){return typeof r=="string"?this.url.searchParams.append(e,`cs.${r}`):Array.isArray(r)?this.url.searchParams.append(e,`cs.{${r.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(r)}`),this}containedBy(e,r){return typeof r=="string"?this.url.searchParams.append(e,`cd.${r}`):Array.isArray(r)?this.url.searchParams.append(e,`cd.{${r.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(r)}`),this}rangeGt(e,r){return this.url.searchParams.append(e,`sr.${r}`),this}rangeGte(e,r){return this.url.searchParams.append(e,`nxl.${r}`),this}rangeLt(e,r){return this.url.searchParams.append(e,`sl.${r}`),this}rangeLte(e,r){return this.url.searchParams.append(e,`nxr.${r}`),this}rangeAdjacent(e,r){return this.url.searchParams.append(e,`adj.${r}`),this}overlaps(e,r){return typeof r=="string"?this.url.searchParams.append(e,`ov.${r}`):this.url.searchParams.append(e,`ov.{${r.join(",")}}`),this}textSearch(e,r,{config:n,type:o}={}){let s="";o==="plain"?s="pl":o==="phrase"?s="ph":o==="websearch"&&(s="w");const a=n===void 0?"":`(${n})`;return this.url.searchParams.append(e,`${s}fts${a}.${r}`),this}match(e){return Object.entries(e).forEach(([r,n])=>{this.url.searchParams.append(r,`eq.${n}`)}),this}not(e,r,n){return this.url.searchParams.append(e,`not.${r}.${n}`),this}or(e,{foreignTable:r,referencedTable:n=r}={}){const o=n?`${n}.or`:"or";return this.url.searchParams.append(o,`(${e})`),this}filter(e,r,n){return this.url.searchParams.append(e,`${r}.${n}`),this}};j.default=bt;var $t=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(ee,"__esModule",{value:!0});const x=$t(j);let kt=class{constructor(e,{headers:r={},schema:n,fetch:o}){this.url=e,this.headers=new Headers(r),this.schema=n,this.fetch=o}select(e,{head:r=!1,count:n}={}){const o=r?"HEAD":"GET";let s=!1;const a=(e??"*").split("").map(d=>/\s/.test(d)&&!s?"":(d==='"'&&(s=!s),d)).join("");return this.url.searchParams.set("select",a),n&&this.headers.append("Prefer",`count=${n}`),new x.default({method:o,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch})}insert(e,{count:r,defaultToNull:n=!0}={}){var o;const s="POST";if(r&&this.headers.append("Prefer",`count=${r}`),n||this.headers.append("Prefer","missing=default"),Array.isArray(e)){const a=e.reduce((d,l)=>d.concat(Object.keys(l)),[]);if(a.length>0){const d=[...new Set(a)].map(l=>`"${l}"`);this.url.searchParams.set("columns",d.join(","))}}return new x.default({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:(o=this.fetch)!==null&&o!==void 0?o:fetch})}upsert(e,{onConflict:r,ignoreDuplicates:n=!1,count:o,defaultToNull:s=!0}={}){var a;const d="POST";if(this.headers.append("Prefer",`resolution=${n?"ignore":"merge"}-duplicates`),r!==void 0&&this.url.searchParams.set("on_conflict",r),o&&this.headers.append("Prefer",`count=${o}`),s||this.headers.append("Prefer","missing=default"),Array.isArray(e)){const l=e.reduce((u,c)=>u.concat(Object.keys(c)),[]);if(l.length>0){const u=[...new Set(l)].map(c=>`"${c}"`);this.url.searchParams.set("columns",u.join(","))}}return new x.default({method:d,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch})}update(e,{count:r}={}){var n;const o="PATCH";return r&&this.headers.append("Prefer",`count=${r}`),new x.default({method:o,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:(n=this.fetch)!==null&&n!==void 0?n:fetch})}delete({count:e}={}){var r;const n="DELETE";return e&&this.headers.append("Prefer",`count=${e}`),new x.default({method:n,url:this.url,headers:this.headers,schema:this.schema,fetch:(r=this.fetch)!==null&&r!==void 0?r:fetch})}};ee.default=kt;var Se=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(me,"__esModule",{value:!0});const It=Se(ee),Bt=Se(j);let Pt=class Me{constructor(e,{headers:r={},schema:n,fetch:o}={}){this.url=e,this.headers=new Headers(r),this.schemaName=n,this.fetch=o}from(e){const r=new URL(`${this.url}/${e}`);return new It.default(r,{headers:new Headers(this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new Me(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,r={},{head:n=!1,get:o=!1,count:s}={}){var a;let d;const l=new URL(`${this.url}/rpc/${e}`);let u;n||o?(d=n?"HEAD":"GET",Object.entries(r).filter(([p,y])=>y!==void 0).map(([p,y])=>[p,Array.isArray(y)?`{${y.join(",")}}`:`${y}`]).forEach(([p,y])=>{l.searchParams.append(p,y)})):(d="POST",u=r);const c=new Headers(this.headers);return s&&c.set("Prefer",`count=${s}`),new Bt.default({method:d,url:l,headers:c,schema:this.schemaName,body:u,fetch:(a=this.fetch)!==null&&a!==void 0?a:fetch})}};me.default=Pt;var C=$&&$.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(_,"__esModule",{value:!0});_.PostgrestError=_.PostgrestBuilder=_.PostgrestTransformBuilder=_.PostgrestFilterBuilder=_.PostgrestQueryBuilder=_.PostgrestClient=void 0;const Ae=C(me);_.PostgrestClient=Ae.default;const Ce=C(ee);_.PostgrestQueryBuilder=Ce.default;const Re=C(j);_.PostgrestFilterBuilder=Re.default;const xe=C(te);_.PostgrestTransformBuilder=xe.default;const De=C(re);_.PostgrestBuilder=De.default;const Oe=C(ne);_.PostgrestError=Oe.default;var Lt=_.default={PostgrestClient:Ae.default,PostgrestQueryBuilder:Ce.default,PostgrestFilterBuilder:Re.default,PostgrestTransformBuilder:xe.default,PostgrestBuilder:De.default,PostgrestError:Oe.default};const{PostgrestClient:Tt,PostgrestQueryBuilder:nn,PostgrestFilterBuilder:on,PostgrestTransformBuilder:sn,PostgrestBuilder:an,PostgrestError:cn}=Lt;var f=class je extends Error{constructor(e,r,n,o){super(e),this.name="InsForgeError",this.statusCode=r,this.error=n,this.nextActions=o}static fromApiError(e){return new je(e.message,e.statusCode,e.error,e.nextActions)}},St=class{constructor(t){if(this.userToken=null,this.baseUrl=t.baseUrl||"http://localhost:7130",this.fetch=t.fetch||(globalThis.fetch?globalThis.fetch.bind(globalThis):void 0),this.anonKey=t.anonKey,this.defaultHeaders={...t.headers},!this.fetch)throw new Error("Fetch is not available. Please provide a fetch implementation in the config.")}buildUrl(t,e){const r=new URL(t,this.baseUrl);return e&&Object.entries(e).forEach(([n,o])=>{if(n==="select"){let s=o.replace(/\s+/g," ").trim();s=s.replace(/\s*\(\s*/g,"(").replace(/\s*\)\s*/g,")").replace(/\(\s+/g,"(").replace(/\s+\)/g,")").replace(/,\s+(?=[^()]*\))/g,","),r.searchParams.append(n,s)}else r.searchParams.append(n,o)}),r.toString()}async request(t,e,r={}){const{params:n,headers:o={},body:s,...a}=r,d=this.buildUrl(e,n),l={...this.defaultHeaders},u=this.userToken||this.anonKey;u&&(l.Authorization=`Bearer ${u}`);let c;s!==void 0&&(typeof FormData<"u"&&s instanceof FormData?c=s:(t!=="GET"&&(l["Content-Type"]="application/json;charset=UTF-8"),c=JSON.stringify(s))),Object.assign(l,o);const p=await this.fetch(d,{method:t,headers:l,body:c,...a});if(p.status===204)return;let y;const w=p.headers.get("content-type");if(w!=null&&w.includes("json")?y=await p.json():y=await p.text(),!p.ok)throw y&&typeof y=="object"&&"error"in y?f.fromApiError(y):new f(`Request failed: ${p.statusText}`,p.status,"REQUEST_FAILED");return y}get(t,e){return this.request("GET",t,e)}post(t,e,r){return this.request("POST",t,{...r,body:e})}put(t,e,r){return this.request("PUT",t,{...r,body:e})}patch(t,e,r){return this.request("PATCH",t,{...r,body:e})}delete(t,e){return this.request("DELETE",t,e)}setAuthToken(t){this.userToken=t}getHeaders(){const t={...this.defaultHeaders},e=this.userToken||this.anonKey;return e&&(t.Authorization=`Bearer ${e}`),t}},z="insforge-auth-token",ae="insforge-auth-user",Mt=class{constructor(t){if(t)this.storage=t;else if(typeof window<"u"&&window.localStorage)this.storage=window.localStorage;else{const e=new Map;this.storage={getItem:r=>e.get(r)||null,setItem:(r,n)=>{e.set(r,n)},removeItem:r=>{e.delete(r)}}}}saveSession(t){this.storage.setItem(z,t.accessToken),this.storage.setItem(ae,JSON.stringify(t.user))}getSession(){const t=this.storage.getItem(z),e=this.storage.getItem(ae);if(!t||!e)return null;try{const r=JSON.parse(e);return{accessToken:t,user:r}}catch{return this.clearSession(),null}}getAccessToken(){const t=this.storage.getItem(z);return typeof t=="string"?t:null}clearSession(){this.storage.removeItem(z),this.storage.removeItem(ae)}};function At(t,e){return async(r,n)=>{var w;const o=typeof r=="string"?r:r.toString(),s=new URL(o),a=s.pathname.slice(1),d=`${t.baseUrl}/api/database/records/${a}${s.search}`,l=e.getAccessToken(),u=t.getHeaders(),c=l||((w=u.Authorization)==null?void 0:w.replace("Bearer ","")),p=new Headers(n==null?void 0:n.headers);return c&&!p.has("Authorization")&&p.set("Authorization",`Bearer ${c}`),await fetch(d,{...n,headers:p})}}var qe=class{constructor(t,e){this.postgrest=new Tt("http://dummy",{fetch:At(t,e),headers:{}})}from(t){return this.postgrest.from(t)}},Ct=class{constructor(t,e){this.http=t,this.tokenManager=e,this.database=new qe(t,e),this.detectOAuthCallback()}detectOAuthCallback(){if(!(typeof window>"u"))try{const t=new URLSearchParams(window.location.search),e=t.get("access_token"),r=t.get("user_id"),n=t.get("email"),o=t.get("name");if(e&&r&&n){const s={accessToken:e,user:{id:r,email:n,name:o||"",emailVerified:!1,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()}};this.tokenManager.saveSession(s),this.http.setAuthToken(e);const a=new URL(window.location.href);a.searchParams.delete("access_token"),a.searchParams.delete("user_id"),a.searchParams.delete("email"),a.searchParams.delete("name"),t.has("error")&&a.searchParams.delete("error"),window.history.replaceState({},document.title,a.toString())}}catch(t){console.debug("OAuth callback detection skipped:",t)}}async signUp(t){try{const e=await this.http.post("/api/auth/users",t),r={accessToken:e.accessToken,user:e.user};return this.tokenManager.saveSession(r),this.http.setAuthToken(e.accessToken),{data:e,error:null}}catch(e){return e instanceof f?{data:null,error:e}:{data:null,error:new f(e instanceof Error?e.message:"An unexpected error occurred during sign up",500,"UNEXPECTED_ERROR")}}}async signInWithPassword(t){try{const e=await this.http.post("/api/auth/sessions",t),r={accessToken:e.accessToken,user:e.user};return this.tokenManager.saveSession(r),this.http.setAuthToken(e.accessToken),{data:e,error:null}}catch(e){return e instanceof f?{data:null,error:e}:{data:null,error:new f("An unexpected error occurred during sign in",500,"UNEXPECTED_ERROR")}}}async signInWithOAuth(t){try{const{provider:e,redirectTo:r,skipBrowserRedirect:n}=t,o=r?{redirect_uri:r}:void 0,s=`/api/auth/oauth/${e}`,a=await this.http.get(s,{params:o});return typeof window<"u"&&!n?(window.location.href=a.authUrl,{data:{},error:null}):{data:{url:a.authUrl,provider:e},error:null}}catch(e){return e instanceof f?{data:{},error:e}:{data:{},error:new f("An unexpected error occurred during OAuth initialization",500,"UNEXPECTED_ERROR")}}}async signOut(){try{return this.tokenManager.clearSession(),this.http.setAuthToken(null),{error:null}}catch{return{error:new f("Failed to sign out",500,"SIGNOUT_ERROR")}}}async getCurrentUser(){try{const t=this.tokenManager.getSession();if(!(t!=null&&t.accessToken))return{data:null,error:null};this.http.setAuthToken(t.accessToken);const e=await this.http.get("/api/auth/sessions/current"),{data:r,error:n}=await this.database.from("users").select("*").eq("id",e.user.id).single();return n&&n.code!=="PGRST116"?{data:null,error:n}:{data:{user:e.user,profile:r},error:null}}catch(t){return t instanceof f&&t.statusCode===401?(await this.signOut(),{data:null,error:null}):t instanceof f?{data:null,error:t}:{data:null,error:new f("An unexpected error occurred while fetching user",500,"UNEXPECTED_ERROR")}}}async getProfile(t){const{data:e,error:r}=await this.database.from("users").select("*").eq("id",t).single();return r&&r.code==="PGRST116"?{data:null,error:null}:{data:e,error:r}}getCurrentSession(){try{const t=this.tokenManager.getSession();return t!=null&&t.accessToken?(this.http.setAuthToken(t.accessToken),{data:{session:t},error:null}):{data:{session:null},error:null}}catch(t){return t instanceof f?{data:{session:null},error:t}:{data:{session:null},error:new f("An unexpected error occurred while getting session",500,"UNEXPECTED_ERROR")}}}async setProfile(t){var o;const e=this.tokenManager.getSession();if(!(e!=null&&e.accessToken))return{data:null,error:new f("No authenticated user found",401,"UNAUTHENTICATED")};if(!((o=e.user)!=null&&o.id)){const{data:s,error:a}=await this.getCurrentUser();if(a)return{data:null,error:a};s!=null&&s.user&&(e.user=s.user,this.tokenManager.saveSession(e))}const{data:r,error:n}=await this.database.from("users").update(t).eq("id",e.user.id).select().single();return{data:r,error:n}}},Rt=class{constructor(t,e){this.bucketName=t,this.http=e}async upload(t,e){try{const r=await this.http.post(`/api/storage/buckets/${this.bucketName}/upload-strategy`,{filename:t,contentType:e.type||"application/octet-stream",size:e.size});if(r.method==="presigned")return await this.uploadWithPresignedUrl(r,e);if(r.method==="direct"){const n=new FormData;return n.append("file",e),{data:await this.http.request("PUT",`/api/storage/buckets/${this.bucketName}/objects/${encodeURIComponent(t)}`,{body:n,headers:{}}),error:null}}throw new f(`Unsupported upload method: ${r.method}`,500,"STORAGE_ERROR")}catch(r){return{data:null,error:r instanceof f?r:new f("Upload failed",500,"STORAGE_ERROR")}}}async uploadAuto(t){try{const e=t instanceof File?t.name:"file",r=await this.http.post(`/api/storage/buckets/${this.bucketName}/upload-strategy`,{filename:e,contentType:t.type||"application/octet-stream",size:t.size});if(r.method==="presigned")return await this.uploadWithPresignedUrl(r,t);if(r.method==="direct"){const n=new FormData;return n.append("file",t),{data:await this.http.request("POST",`/api/storage/buckets/${this.bucketName}/objects`,{body:n,headers:{}}),error:null}}throw new f(`Unsupported upload method: ${r.method}`,500,"STORAGE_ERROR")}catch(e){return{data:null,error:e instanceof f?e:new f("Upload failed",500,"STORAGE_ERROR")}}}async uploadWithPresignedUrl(t,e){try{const r=new FormData;t.fields&&Object.entries(t.fields).forEach(([o,s])=>{r.append(o,s)}),r.append("file",e);const n=await fetch(t.uploadUrl,{method:"POST",body:r});if(!n.ok)throw new f(`Upload to storage failed: ${n.statusText}`,n.status,"STORAGE_ERROR");return t.confirmRequired&&t.confirmUrl?{data:await this.http.post(t.confirmUrl,{size:e.size,contentType:e.type||"application/octet-stream"}),error:null}:{data:{key:t.key,bucket:this.bucketName,size:e.size,mimeType:e.type||"application/octet-stream",uploadedAt:new Date().toISOString(),url:this.getPublicUrl(t.key)},error:null}}catch(r){throw r instanceof f?r:new f("Presigned upload failed",500,"STORAGE_ERROR")}}async download(t){try{const e=await this.http.post(`/api/storage/buckets/${this.bucketName}/objects/${encodeURIComponent(t)}/download-strategy`,{expiresIn:3600}),r=e.url,n={};e.method==="direct"&&Object.assign(n,this.http.getHeaders());const o=await fetch(r,{method:"GET",headers:n});if(!o.ok)try{const a=await o.json();throw f.fromApiError(a)}catch{throw new f(`Download failed: ${o.statusText}`,o.status,"STORAGE_ERROR")}return{data:await o.blob(),error:null}}catch(e){return{data:null,error:e instanceof f?e:new f("Download failed",500,"STORAGE_ERROR")}}}getPublicUrl(t){return`${this.http.baseUrl}/api/storage/buckets/${this.bucketName}/objects/${encodeURIComponent(t)}`}async list(t){try{const e={};return t!=null&&t.prefix&&(e.prefix=t.prefix),t!=null&&t.search&&(e.search=t.search),t!=null&&t.limit&&(e.limit=t.limit.toString()),t!=null&&t.offset&&(e.offset=t.offset.toString()),{data:await this.http.get(`/api/storage/buckets/${this.bucketName}/objects`,{params:e}),error:null}}catch(e){return{data:null,error:e instanceof f?e:new f("List failed",500,"STORAGE_ERROR")}}}async remove(t){try{return{data:await this.http.delete(`/api/storage/buckets/${this.bucketName}/objects/${encodeURIComponent(t)}`),error:null}}catch(e){return{data:null,error:e instanceof f?e:new f("Delete failed",500,"STORAGE_ERROR")}}}},xt=class{constructor(t){this.http=t}from(t){return new Rt(t,this.http)}},Dt=class{constructor(t){this.http=t,this.chat=new Ot(t),this.images=new qt(t)}},Ot=class{constructor(t){this.completions=new jt(t)}},jt=class{constructor(t){this.http=t}async create(t){var o,s;const e={model:t.model,messages:t.messages,temperature:t.temperature,maxTokens:t.maxTokens,topP:t.topP,stream:t.stream};if(t.stream){const a=this.http.getHeaders();a["Content-Type"]="application/json";const d=await this.http.fetch(`${this.http.baseUrl}/api/ai/chat/completion`,{method:"POST",headers:a,body:JSON.stringify(e)});if(!d.ok){const l=await d.json();throw new Error(l.error||"Stream request failed")}return this.parseSSEStream(d,t.model)}const r=await this.http.post("/api/ai/chat/completion",e),n=r.text||"";return{id:`chatcmpl-${Date.now()}`,object:"chat.completion",created:Math.floor(Date.now()/1e3),model:(o=r.metadata)==null?void 0:o.model,choices:[{index:0,message:{role:"assistant",content:n},finish_reason:"stop"}],usage:((s=r.metadata)==null?void 0:s.usage)||{prompt_tokens:0,completion_tokens:0,total_tokens:0}}}async*parseSSEStream(t,e){const r=t.body.getReader(),n=new TextDecoder;let o="";try{for(;;){const{done:s,value:a}=await r.read();if(s)break;o+=n.decode(a,{stream:!0});const d=o.split(`
`);o=d.pop()||"";for(const l of d)if(l.startsWith("data: ")){const u=l.slice(6).trim();if(u)try{const c=JSON.parse(u);if((c.chunk||c.content)&&(yield{id:`chatcmpl-${Date.now()}`,object:"chat.completion.chunk",created:Math.floor(Date.now()/1e3),model:e,choices:[{index:0,delta:{content:c.chunk||c.content},finish_reason:c.done?"stop":null}]}),c.done){r.releaseLock();return}}catch{console.warn("Failed to parse SSE data:",u)}}}}finally{r.releaseLock()}}},qt=class{constructor(t){this.http=t}async generate(t){var n;const e=await this.http.post("/api/ai/image/generation",t);let r=[];return e.images&&e.images.length>0?r=e.images.map(o=>({b64_json:o.imageUrl.replace(/^data:image\/\w+;base64,/,""),content:e.text})):e.text&&(r=[{content:e.text}]),{created:Math.floor(Date.now()/1e3),data:r,...((n=e.metadata)==null?void 0:n.usage)&&{usage:{total_tokens:e.metadata.usage.totalTokens||0,input_tokens:e.metadata.usage.promptTokens||0,output_tokens:e.metadata.usage.completionTokens||0}}}}},Gt=class{constructor(t){this.http=t}async invoke(t,e={}){try{const{method:r="POST",body:n,headers:o={}}=e,s=`/functions/${t}`;return{data:await this.http.request(r,s,{body:n,headers:o}),error:null}}catch(r){return{data:null,error:new Error(r.message||"Failed to invoke function")}}}},Ut=class{constructor(t={}){this.http=new St(t),this.tokenManager=new Mt(t.storage),t.edgeFunctionToken&&(this.http.setAuthToken(t.edgeFunctionToken),this.tokenManager.saveSession({accessToken:t.edgeFunctionToken,user:{}}));const e=this.tokenManager.getSession();e!=null&&e.accessToken&&this.http.setAuthToken(e.accessToken),this.auth=new Ct(this.http,this.tokenManager),this.database=new qe(this.http,this.tokenManager),this.storage=new xt(this.http),this.ai=new Dt(this.http),this.functions=new Gt(this.http)}getHttpClient(){return this.http}};function Nt(t){return new Ut(t)}const h=Nt({baseUrl:"https://3wppa5bh.us-east.insforge.app"});let m=null,L=null,B=[],J=[],Q=[],ie=[],K=[],ce=[],le=[],de=[],A="personal",W=null,T=[],b=[],I=0,V="all";const Ft=document.getElementById("loginPage"),Ht=document.getElementById("mainPage"),zt=document.getElementById("loginForm"),Vt=document.getElementById("registerForm");document.getElementById("inspirationModal");document.getElementById("inspirationDetailModal");const he=document.getElementById("inspirationForm");function $e(){const t=document.getElementById("homePage"),e=document.getElementById("loginPage"),r=document.getElementById("mainPage");t&&t.classList.remove("hidden"),e&&e.classList.add("hidden"),r&&r.classList.add("hidden")}function Jt(){const t=document.getElementById("homePage"),e=document.getElementById("loginPage"),r=document.getElementById("mainPage");t&&t.classList.add("hidden"),e&&e.classList.remove("hidden"),r&&r.classList.add("hidden");const n=document.querySelector('[data-tab="login"]');n&&n.click()}function Qt(){const t=document.getElementById("homePage"),e=document.getElementById("loginPage"),r=document.getElementById("mainPage");t&&t.classList.add("hidden"),e&&e.classList.remove("hidden"),r&&r.classList.add("hidden");const n=document.querySelector('[data-tab="register"]');n&&n.click()}function Kt(){const t=document.getElementById("features");t&&t.scrollIntoView({behavior:"smooth"})}function pe(){console.log("showMainApp called");const t=document.getElementById("homePage"),e=document.getElementById("loginPage"),r=document.getElementById("mainPage");t&&t.classList.add("hidden"),e&&e.classList.add("hidden"),r&&r.classList.remove("hidden"),nr(),console.log("Initializing social features..."),Ur(),console.log("Initializing notifications..."),typeof Pe=="function"&&Pe(),Xr()}async function Wt(){var t;try{const{data:e}=await h.auth.getCurrentSession();if((t=e==null?void 0:e.session)!=null&&t.accessToken){const{data:r}=await h.auth.getCurrentUser();if(r!=null&&r.user)return m=r,pe(),await S(),!0}return $e(),!1}catch(e){return console.error("检查登录状态失败:",e),$e(),!1}}document.addEventListener("DOMContentLoaded",async()=>{lucide.createIcons(),Xt(),window.i18n&&(window.i18n.updatePageContent(),be()),await Wt()||lucide.createIcons()});function Xt(){document.querySelectorAll(".tab-btn").forEach(t=>{t.addEventListener("click",()=>Yt(t.dataset.tab))}),zt.addEventListener("submit",Zt),Vt.addEventListener("submit",er),document.getElementById("googleLogin").addEventListener("click",()=>ke("google")),document.getElementById("githubLogin").addEventListener("click",()=>ke("github")),document.getElementById("addInspirationBtn").addEventListener("click",()=>ge()),document.getElementById("inboxBtn").addEventListener("click",()=>D("notifications")),document.getElementById("userMenuBtn").addEventListener("click",or),document.getElementById("logoutBtn").addEventListener("click",tr),document.getElementById("searchInput").addEventListener("input",Ie),document.getElementById("searchBtn").addEventListener("click",Ie),document.getElementById("categoryFilter").addEventListener("change",Be),document.getElementById("moodFilter").addEventListener("change",Be),document.getElementById("favoritesOnlyBtn").addEventListener("click",ar),he.addEventListener("submit",Ge),document.addEventListener("click",t=>{t.target.classList.contains("modal")&&(oe(),Y()),t.target.closest(".user-menu")||sr()})}function Yt(t){document.querySelectorAll(".tab-btn").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".form-content").forEach(e=>e.classList.remove("active")),document.querySelector(`[data-tab="${t}"]`).classList.add("active"),document.getElementById(`${t}Form`).classList.add("active")}async function Zt(t){t.preventDefault();const e=document.getElementById("loginEmail").value,r=document.getElementById("loginPassword").value;try{v(!0);const{data:n,error:o}=await h.auth.signInWithPassword({email:e,password:r});if(o){i(o.message||"登录失败","error");return}m=n,i("auth.loginSuccess","success"),pe(),await S()}catch(n){console.error("Login error:",n),i("登录失败，请稍后重试","error")}finally{v(!1)}}async function er(t){t.preventDefault();const e=document.getElementById("registerEmail").value,r=document.getElementById("registerPassword").value,n=document.getElementById("registerNickname").value;try{v(!0);const{data:o,error:s}=await h.auth.signUp({email:e,password:r});if(s){i(s.message||"注册失败","error");return}await h.auth.setProfile({nickname:n,bio:"灵感记录者"}),m=o,i("auth.registerSuccess","success"),pe(),await S()}catch(o){console.error("Register error:",o),i("注册失败，请稍后重试","error")}finally{v(!1)}}async function ke(t){try{const{data:e,error:r}=await h.auth.signInWithOAuth({provider:t,redirectTo:window.location.origin,skipBrowserRedirect:!0});if(r){i(r.message||"OAuth登录失败","error");return}e!=null&&e.url&&(window.location.href=e.url)}catch(e){console.error("OAuth error:",e),i("OAuth登录失败，请稍后重试","error")}}async function tr(){try{await h.auth.signOut(),m=null,B=[],rr(),i("已退出登录","success")}catch(t){console.error("Logout error:",t),i("退出登录失败","error")}}function rr(){Ft.classList.remove("hidden"),Ht.classList.add("hidden")}function nr(){if(m!=null&&m.profile){document.getElementById("userNickname").textContent=m.profile.nickname||m.user.email;const t=document.getElementById("userAvatarImg");t.src=m.profile.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(m.profile.nickname||m.user.email)}&background=667eea&color=fff`}}function or(){document.getElementById("userDropdown").classList.toggle("hidden")}function sr(){document.getElementById("userDropdown").classList.add("hidden")}async function S(){try{v(!0);const{data:t,error:e}=await h.database.from("inspirations").select("*").eq("user_id",m.user.id).order("created_at",{ascending:!1});if(e){i("加载灵感失败","error");return}B=t||[],J=[...B],X()}catch(t){console.error("Load inspirations error:",t),i("加载灵感失败","error")}finally{v(!1)}}function X(){const t=document.getElementById("inspirationsList"),e=document.getElementById("emptyState");if(J.length===0){t.innerHTML="",e.classList.remove("hidden");return}e.classList.add("hidden"),t.innerHTML=J.map(r=>`
        <div class="inspiration-card ${r.is_favorite?"favorite":""}"
             onclick="showInspirationDetail('${r.id}')">
            <div class="card-header">
                <h3 class="card-title">${g(r.title)}</h3>
            </div>
            <div class="card-meta">
                <span class="card-tag">${ve(r.category)}</span>
                <span class="card-tag">${we(r.mood)}</span>
                ${r.is_private?'<span class="card-tag">私有</span>':""}
            </div>
            ${r.image_url?`<img src="${r.image_url}" alt="灵感图片" class="card-image">`:""}
            <div class="card-content">${g(r.content)}</div>
            ${r.tags&&r.tags.length>0?`
                <div class="card-footer">
                    <div class="card-tags">
                        ${r.tags.map(n=>`<span class="card-tag">#${g(n)}</span>`).join("")}
                    </div>
                </div>
            `:""}
            ${r.location_city||r.weather_condition?`
                <div class="card-context">
                    ${r.location_city?`<span class="location-info">${P("map-pin")} ${g(r.location_city)}</span>`:""}
                    ${r.weather_condition?`
                        <span class="weather-info">
                            ${P("cloud")} ${g(r.weather_condition)}
                            ${r.weather_temperature!==null?` ${r.weather_temperature}°C`:""}
                        </span>
                    `:""}
                </div>
            `:""}
            <div class="card-footer">
                <span>${G(r.created_at)}</span>
                <div class="card-actions">
                    <button class="btn-icon" onclick="event.stopPropagation(); toggleFavorite('${r.id}')">
                        ${r.is_favorite?P("star","star-filled"):P("star")}
                    </button>
                    <button class="btn-icon" onclick="event.stopPropagation(); editInspiration('${r.id}')">${P("edit")}</button>
                    <button class="btn-icon" onclick="event.stopPropagation(); deleteInspiration('${r.id}')">${P("trash-2")}</button>
                </div>
            </div>
        </div>
    `).join(""),typeof lucide<"u"&&lucide.createIcons()}function Ie(){document.getElementById("searchInput").value.toLowerCase(),fe()}function Be(){fe()}function ar(){document.getElementById("favoritesOnlyBtn").classList.toggle("active"),fe()}function fe(){const t=document.getElementById("searchInput").value.toLowerCase(),e=document.getElementById("categoryFilter").value,r=document.getElementById("moodFilter").value,n=document.getElementById("favoritesOnlyBtn").classList.contains("active");J=B.filter(o=>!(t&&!o.title.toLowerCase().includes(t)&&!o.content.toLowerCase().includes(t)||e&&o.category!==e||r&&o.mood!==r||n&&!o.is_favorite)),X()}function ge(t=null){L=t;const e=document.getElementById("inspirationModal"),r=document.getElementById("modalTitle");t?(r.textContent="编辑灵感",ir(t)):(r.textContent="记录灵感",he.reset()),e.classList.remove("hidden")}function oe(){document.getElementById("inspirationModal").classList.add("hidden"),L=null,he.reset()}function ir(t){document.getElementById("inspirationTitle").value=t.title,document.getElementById("inspirationContent").value=t.content,document.getElementById("inspirationCategory").value=t.category,document.getElementById("inspirationMood").value=t.mood,document.getElementById("inspirationTags").value=t.tags?t.tags.join(", "):"",document.getElementById("isPrivate").checked=t.is_private}async function Ge(t){t.preventDefault();const e=document.getElementById("inspirationTitle").value,r=document.getElementById("inspirationContent").value,n=document.getElementById("inspirationCategory").value,o=document.getElementById("inspirationMood").value,s=document.getElementById("inspirationTags").value,a=document.getElementById("isPrivate").checked,d=document.getElementById("inspirationImage").files[0];try{v(!0);let l=(L==null?void 0:L.image_url)||null;if(d){const{data:c,error:p}=await h.storage.from("inspiration-files").uploadAuto(d);if(p){i("图片上传失败","error");return}l=c.url}const u={title:e,content:r,category:n,mood:o,tags:s?s.split(",").map(c=>c.trim()).filter(c=>c):[],is_private:a,image_url:l,user_id:m.user.id};if(L){const{data:c,error:p}=await h.database.from("inspirations").update(u).eq("id",L.id).select().single();if(p){i("更新灵感失败","error");return}i("灵感更新成功！","success")}else{const{data:c,error:p}=await h.functions.invoke("create-inspiration",{body:u});if(p){console.error("Function invoke error:",p),i("保存灵感失败","error");return}if(!c.success){console.error("Function returned error:",c.error),i(c.error||"保存灵感失败","error");return}let y="灵感记录成功！";c.location&&c.location.city&&(y+=` 📍 ${c.location.city}`),c.weather&&c.weather.condition&&(y+=` ☁️ ${c.weather.condition}`,c.weather.temperature!==null&&(y+=` ${c.weather.temperature}°C`)),i(y,"success")}oe(),await S()}catch(l){console.error("Save inspiration error:",l),i("操作失败，请稍后重试","error")}finally{v(!1)}}function Ue(t){const e=B.find(r=>r.id===t);e&&ge(e)}async function Ne(t){if(confirm("确定要删除这个灵感吗？此操作无法撤销。"))try{v(!0);const{error:e}=await h.database.from("inspirations").delete().eq("id",t);if(e){i("删除失败","error");return}i("删除成功","success"),await S()}catch(e){console.error("Delete inspiration error:",e),i("删除失败","error")}finally{v(!1)}}async function Fe(t){const e=B.find(r=>r.id===t);if(e)try{const{error:r}=await h.database.from("inspirations").update({is_favorite:!e.is_favorite}).eq("id",t);if(r){i("操作失败","error");return}await S()}catch(r){console.error("Toggle favorite error:",r),i("操作失败","error")}}function ye(t){const e=B.find(r=>r.id===t);e&&(document.getElementById("detailTitle").textContent=e.title,document.getElementById("detailContent").textContent=e.content,document.getElementById("detailMeta").innerHTML=`
        <span>分类：${ve(e.category)}</span>
        <span>心情：${we(e.mood)}</span>
        <span>创建时间：${G(e.created_at)}</span>
        ${e.is_private?"<span>私有</span>":""}
        ${e.location_city?`<span>${P("map-pin")} 位置：${g(e.location_city)}</span>`:""}
        ${e.weather_condition?`
            <span>${P("cloud")} 天气：${g(e.weather_condition)}
                ${e.weather_temperature!==null?` (${e.weather_temperature}°C)`:""}
                ${e.weather_humidity!==null?` 湿度${e.weather_humidity}%`:""}
            </span>
        `:""}
    `,e.tags&&e.tags.length>0?document.getElementById("detailTags").innerHTML=e.tags.map(r=>`<span class="detail-tag">#${g(r)}</span>`).join(""):document.getElementById("detailTags").innerHTML="",e.image_url?document.getElementById("detailImage").innerHTML=`<img src="${e.image_url}" alt="灵感图片">`:document.getElementById("detailImage").innerHTML="",document.getElementById("favoriteBtn").onclick=()=>Fe(t),document.getElementById("editBtn").onclick=()=>{Y(),Ue(t)},document.getElementById("deleteBtn").onclick=()=>{Y(),Ne(t)},q(t),document.getElementById("inspirationDetailModal").classList.remove("hidden"))}async function q(t){try{const{data:e,error:r}=await h.database.from("likes").select("*").eq("inspiration_id",t);if(r)console.error("Error loading likes:",r);else{const a=e.length,d=e.some(u=>{var c;return u.user_id===((c=m==null?void 0:m.user)==null?void 0:c.id)});document.getElementById("likeCount").textContent=a;const l=document.getElementById("likeBtn");l.classList.toggle("liked",d),l.onclick=()=>cr(t)}const{data:n,error:o}=await h.database.from("comments").select(`
                *,
                users!inner(id, nickname, avatar_url)
            `).eq("inspiration_id",t).order("created_at",{ascending:!0});o?console.error("Error loading comments:",o):ur(n);const s=document.getElementById("addCommentForm");s.onsubmit=a=>lr(a,t)}catch(e){console.error("Error loading comments and likes:",e)}}async function cr(t){var e;if(!((e=m==null?void 0:m.user)!=null&&e.id)){i("请先登录");return}try{const{data:r,error:n}=await h.functions.invoke("toggle-like",{body:{inspiration_id:t}});if(n){console.error("Error toggling like:",n),i(n.message||"操作失败");return}r.action==="liked"?i("点赞成功"):r.action==="unliked"&&i("已取消点赞"),q(t)}catch(r){console.error("Error toggling like:",r),i("操作失败")}}async function lr(t,e){var o;if(t.preventDefault(),!((o=m==null?void 0:m.user)!=null&&o.id)){i("请先登录");return}const r=document.getElementById("commentInput"),n=r.value.trim();if(!n){i("请输入评论内容");return}try{const{data:s,error:a}=await h.functions.invoke("add-comment",{body:{inspiration_id:e,content:n}});if(a){console.error("Error adding comment:",a),i(a.message||"评论失败");return}r.value="",i("评论成功"),q(e)}catch(s){console.error("Error submitting comment:",s),i("评论失败")}}async function dr(t,e,r,n=null){var d;if(t.preventDefault(),!((d=m==null?void 0:m.user)!=null&&d.id)){i("请先登录");return}const o=t.target,s=o.querySelector("textarea");let a=s.value.trim();if(!a){i("请输入回复内容");return}n&&!a.startsWith(`@${n}`)&&(a=`@${n} ${a}`);try{const{data:l,error:u}=await h.functions.invoke("add-comment",{body:{inspiration_id:e,content:a,parent_comment_id:r}});if(u){console.error("Error adding reply:",u),i(u.message||"回复失败");return}s.value="",i("回复成功"),o.remove(),q(e)}catch(l){console.error("Error submitting reply:",l),i("回复失败")}}function ur(t){const e=document.getElementById("commentsList"),r=document.getElementById("commentsEmpty"),n=document.getElementById("commentCount");if(n.textContent=t.length,t.length===0){e.innerHTML="",r.classList.remove("hidden");return}r.classList.add("hidden");const o=t.map(s=>{var u,c,p,y,w,E;const a=s.parent_comment_id!==null,d=((u=s.users)==null?void 0:u.avatar_url)||`https://api.dicebear.com/7.x/avataaars/svg?seed=${((c=s.users)==null?void 0:c.nickname)||"user"}`;let l=g(s.content);return s.mentioned_users&&s.mentioned_users.length>0&&s.mentioned_users.forEach(N=>{const k=new RegExp(`@${N}`,"g");l=l.replace(k,`<span class="comment-mention">@${N}</span>`)}),`
            <div class="comment-item ${a?"comment-reply":""}" data-comment-id="${s.id}">
                <div class="comment-header">
                    <div class="comment-author">
                        <img src="${d}" alt="${g(((p=s.users)==null?void 0:p.nickname)||"User")}" class="comment-avatar">
                        <span class="comment-author-name">${g(((y=s.users)==null?void 0:y.nickname)||"Unknown User")}</span>
                    </div>
                    <span class="comment-time">${G(s.created_at)}</span>
                </div>
                <div class="comment-content">${l}</div>
                <div class="comment-actions">
                    <button class="comment-action-btn" onclick="showReplyForm('${s.id}', '${((w=s.users)==null?void 0:w.nickname)||""}')">
                        <i data-lucide="reply"></i> 回复
                    </button>
                    ${s.user_id===((E=m==null?void 0:m.user)==null?void 0:E.id)?`
                        <button class="comment-action-btn" onclick="deleteComment('${s.id}')">
                            <i data-lucide="trash-2"></i> 删除
                        </button>
                    `:""}
                </div>
            </div>
        `}).join("");e.innerHTML=o,lucide.createIcons()}function mr(t,e){document.querySelectorAll(".reply-form").forEach(a=>a.remove());const r=document.querySelector(`[data-comment-id="${t}"]`),n=B.find(a=>a.id===He()),o=document.createElement("form");o.className="reply-form",o.innerHTML=`
        <div class="comment-input-group">
            <textarea placeholder="回复 @${e}..." rows="2"></textarea>
            <button type="submit" class="btn-primary btn-sm">
                <i data-lucide="send"></i>
            </button>
        </div>
    `,o.onsubmit=a=>dr(a,n.id,t,e),r.appendChild(o),o.querySelector("textarea").focus(),lucide.createIcons()}async function hr(t){if(confirm("确定要删除这条评论吗？"))try{const{error:e}=await h.database.from("comments").delete().eq("id",t).eq("user_id",m.user.id);if(e){console.error("Error deleting comment:",e),i("删除评论失败");return}i("评论已删除");const r=He();r&&q(r)}catch(e){console.error("Error deleting comment:",e),i("删除评论失败")}}function He(){if(document.getElementById("inspirationDetailModal").classList.contains("hidden"))return null;const e=document.getElementById("detailTitle").textContent,r=B.find(n=>n.title===e);return(r==null?void 0:r.id)||null}function Y(){document.getElementById("inspirationDetailModal").classList.add("hidden")}function v(t){const e=document.getElementById("loadingSpinner");t?e.classList.remove("hidden"):e.classList.add("hidden")}function i(t,e="info"){const r=document.getElementById("toast"),n=document.getElementById("toastMessage"),o=window.t?window.t(t):t;n.textContent=o===t?t:o,r.className=`toast ${e}`,r.classList.remove("hidden"),setTimeout(()=>{ze()},3e3)}function ze(){document.getElementById("toast").classList.add("hidden")}function G(t){return new Date(t).toLocaleDateString("zh-CN",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}function ve(t){return{idea:"想法",quote:"引言",thought:"思考",solution:"解决方案"}[t]||t}function we(t){return{excited:"兴奋",calm:"平静",frustrated:"沮丧",hopeful:"充满希望"}[t]||t}function g(t){const e=document.createElement("div");return e.textContent=t,e.innerHTML}function P(t,e=""){return`<i data-lucide="${t}" class="${e}"></i>`}function pr(){var e,r,n,o,s,a,d,l,u;console.log("Setting up social navigation...");const t=document.querySelectorAll(".nav-tab");console.log("Found nav tabs:",t.length),t.forEach(c=>{console.log("Adding event listener to tab:",c.dataset.tab),c.addEventListener("click",()=>{console.log("Tab clicked:",c.dataset.tab),D(c.dataset.tab)})}),(e=document.getElementById("createGroupBtn"))==null||e.addEventListener("click",Ye),(r=document.getElementById("createGroupForm"))==null||r.addEventListener("submit",Ar),(n=document.getElementById("applyGroupForm"))==null||n.addEventListener("submit",Tr),(o=document.getElementById("shareToGroupBtn"))==null||o.addEventListener("click",()=>et(L)),(s=document.getElementById("confirmShareBtn"))==null||s.addEventListener("click",Gr),(a=document.getElementById("userSearchBtn"))==null||a.addEventListener("click",Cr),(d=document.getElementById("followUserBtn"))==null||d.addEventListener("click",Rr),(l=document.getElementById("joinGroupBtn"))==null||l.addEventListener("click",xr),(u=document.getElementById("leaveGroupBtn"))==null||u.addEventListener("click",Dr)}function D(t){console.log("switchTab called with:",t),document.querySelectorAll(".nav-tab").forEach(n=>{n.classList.remove("active")});const e=document.querySelector(`[data-tab="${t}"]`);e?(e.classList.add("active"),console.log("Active tab set for:",t)):console.error("Could not find tab with data-tab:",t),document.querySelectorAll(".tab-content").forEach(n=>{n.classList.remove("active"),n.classList.add("hidden")});const r=document.getElementById(`${t}Tab`);if(r)r.classList.add("active"),r.classList.remove("hidden"),console.log("Target tab content shown for:",t),A=t,fr(t);else{console.error("Could not find tab content with id:",`${t}Tab`),console.log("Available tab content elements:"),document.querySelectorAll(".tab-content").forEach(n=>{console.log("- ",n.id)});return}}async function fr(t){try{switch(v(!0),t){case"personal":await S();break;case"groups":await se();break;case"following":await Ee();break;case"discover":await Ve();break}}catch(e){console.error(`Error loading ${t} data:`,e),i(`加载${t}数据失败`,"error")}finally{v(!1)}}async function se(){try{const{data:t,error:e}=await h.database.from("group_members").select(`
                groups (
                    id, name, description, avatar_url, is_private,
                    member_count, created_at, creator_id
                )
            `).eq("user_id",m.user.id);e?console.error("加载我的小组失败:",e):(Q=(t==null?void 0:t.map(o=>o.groups))||[],gr());const{data:r,error:n}=await h.database.from("groups").select("*").eq("is_private",!1).limit(10);if(n)console.error("加载发现小组失败:",n);else{const o=Q.map(s=>s.id);ie=(r==null?void 0:r.filter(s=>!o.includes(s.id)))||[],yr()}}catch(t){console.error("Error loading groups:",t),i("加载小组失败","error")}}function gr(){const t=document.getElementById("myGroupsList");if(t){if(Q.length===0){t.innerHTML='<div class="empty-state"><p>你还没有加入任何小组</p></div>';return}t.innerHTML=Q.map(e=>`
        <div class="group-card" onclick="showGroupDetail('${e.id}')">
            <div class="group-avatar">${e.avatar_url?`<img src="${e.avatar_url}" alt="${e.name}">`:e.name.charAt(0)}</div>
            <div class="group-name">${g(e.name)}</div>
            <div class="group-description">${g(e.description||"")}</div>
            <div class="group-meta">
                <span>${e.member_count} 成员</span>
                ${e.is_private?'<span class="group-private">私有</span>':""}
            </div>
        </div>
    `).join("")}}function yr(){const t=document.getElementById("discoverGroupsList");if(t){if(ie.length===0){t.innerHTML='<div class="empty-state"><p>暂无可发现的小组</p></div>';return}t.innerHTML=ie.map(e=>`
        <div class="group-card" onclick="showGroupDetail('${e.id}')">
            <div class="group-avatar">${e.avatar_url?`<img src="${e.avatar_url}" alt="${e.name}">`:e.name.charAt(0)}</div>
            <div class="group-name">${g(e.name)}</div>
            <div class="group-description">${g(e.description||"")}</div>
            <div class="group-meta">
                <span>${e.member_count} 成员</span>
                <button class="btn-primary" onclick="event.stopPropagation(); joinGroup('${e.id}')">加入</button>
            </div>
        </div>
    `).join("")}}async function Ee(){try{const{data:t,error:e}=await h.database.from("follows").select(`
                following_id,
                users!follows_following_id_fkey (
                    id, nickname, bio, avatar_url
                )
            `).eq("follower_id",m.user.id);e?console.error("加载关注列表失败:",e):(K=(t==null?void 0:t.map(o=>o.users))||[],vr());const{data:r,error:n}=await h.database.from("follows").select(`
                follower_id,
                users!follows_follower_id_fkey (
                    id, nickname, bio, avatar_url
                )
            `).eq("following_id",m.user.id);n?console.error("加载粉丝列表失败:",n):(ce=(r==null?void 0:r.map(o=>o.users))||[],wr()),await Er()}catch(t){console.error("Error loading following data:",t),i("加载关注数据失败","error")}}function vr(){const t=document.getElementById("followingList");if(t){if(K.length===0){t.innerHTML='<div class="empty-state"><p>你还没有关注任何人</p></div>';return}t.innerHTML=K.map(e=>`
        <div class="user-card" onclick="showUserDetail('${e.id}')">
            <img class="user-avatar" src="${e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.nickname||e.id)}&background=667eea&color=fff`}" alt="${e.nickname}">
            <div class="user-nickname">${g(e.nickname||"Unknown")}</div>
            <div class="user-bio">${g(e.bio||"")}</div>
            <button class="follow-btn following" onclick="event.stopPropagation(); unfollowUser('${e.id}')">已关注</button>
        </div>
    `).join("")}}function wr(){const t=document.getElementById("followersList");if(t){if(ce.length===0){t.innerHTML='<div class="empty-state"><p>还没有人关注你</p></div>';return}t.innerHTML=ce.map(e=>`
        <div class="user-card" onclick="showUserDetail('${e.id}')">
            <img class="user-avatar" src="${e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.nickname||e.id)}&background=667eea&color=fff`}" alt="${e.nickname}">
            <div class="user-nickname">${g(e.nickname||"Unknown")}</div>
            <div class="user-bio">${g(e.bio||"")}</div>
        </div>
    `).join("")}}async function Er(){try{const{data:t,error:e}=await h.database.from("inspiration_shares").select(`
                inspirations (
                    id, title, content, tags, category, mood, image_url,
                    created_at, user_id,
                    users (nickname, avatar_url)
                ),
                groups (name),
                shared_at
            `).order("shared_at",{ascending:!1}).limit(20);if(e){console.error("加载小组灵感失败:",e);return}de=t||[],_r()}catch(t){console.error("Error loading group inspirations:",t)}}function _r(){const t=document.getElementById("groupInspirationsList");if(t){if(de.length===0){t.innerHTML='<div class="empty-state"><p>还没有小组分享的灵感</p></div>';return}t.innerHTML=de.map(e=>{const r=e.inspirations;return`
            <div class="inspiration-card" onclick="showInspirationDetail('${r.id}')">
                <div class="card-header">
                    <h3 class="card-title">${g(r.title)}</h3>
                    <div class="share-info">
                        <small>来自小组: ${g(e.groups.name)}</small>
                    </div>
                </div>
                <div class="card-meta">
                    <span class="card-tag">${ve(r.category)}</span>
                    <span class="card-tag">${we(r.mood)}</span>
                </div>
                ${r.image_url?`<img src="${r.image_url}" alt="灵感图片" class="card-image">`:""}
                <div class="card-content">${g(r.content)}</div>
                <div class="card-footer">
                    <div class="author-info">
                        <img src="${r.users.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(r.users.nickname||"Unknown")}&background=667eea&color=fff`}" class="author-avatar">
                        <span>${g(r.users.nickname||"Unknown")}</span>
                    </div>
                    <span>${G(e.shared_at)}</span>
                </div>
            </div>
        `}).join("")}}async function Ve(){try{const{data:t,error:e}=await h.database.from("users").select("*").neq("id",m.user.id).limit(20);if(e){console.error("加载用户列表失败:",e);return}const r=K.map(n=>n.id);le=(t==null?void 0:t.filter(n=>!r.includes(n.id)))||[],br()}catch(t){console.error("Error loading discover users:",t),i("加载用户失败","error")}}function br(){const t=document.getElementById("discoverUsersList");if(t){if(le.length===0){t.innerHTML='<div class="empty-state"><p>没有更多用户可以发现</p></div>';return}t.innerHTML=le.map(e=>`
        <div class="user-card" onclick="showUserDetail('${e.id}')">
            <img class="user-avatar" src="${e.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(e.nickname||e.id)}&background=667eea&color=fff`}" alt="${e.nickname}">
            <div class="user-nickname">${g(e.nickname||"Unknown")}</div>
            <div class="user-bio">${g(e.bio||"")}</div>
            <button class="follow-btn" onclick="event.stopPropagation(); followUser('${e.id}')">关注</button>
        </div>
    `).join("")}}async function $r(t){try{const{error:e}=await h.database.from("follows").insert([{follower_id:m.user.id,following_id:t}]);if(e){i("关注失败","error");return}i("关注成功","success"),A==="following"?await Ee():A==="discover"&&await Ve()}catch(e){console.error("Follow user error:",e),i("关注失败","error")}}async function kr(t){try{const{error:e}=await h.database.from("follows").delete().eq("follower_id",m.user.id).eq("following_id",t);if(e){i("取消关注失败","error");return}i("已取消关注","success"),A==="following"&&await Ee()}catch(e){console.error("Unfollow user error:",e),i("取消关注失败","error")}}async function Ir(t){try{const{error:e}=await h.database.from("group_members").insert([{group_id:t,user_id:m.user.id,role:"member"}]);if(e){i("加入小组失败","error");return}const{error:r}=await h.database.from("groups").update({member_count:h.database.raw("member_count + 1")}).eq("id",t);i("成功加入小组","success"),await se()}catch(e){console.error("Join group error:",e),i("加入小组失败","error")}}async function Br(t){try{v(!0);const{data:e,error:r}=await h.database.from("groups").select("*").eq("id",t).single();if(r){console.error("获取小组信息失败:",r),i("获取小组信息失败","error");return}const{data:n,error:o}=await h.database.from("group_members").select("*").eq("group_id",t).eq("user_id",m.user.id).single(),s=n&&!o,a=!e.is_private||s;document.getElementById("groupDetailName").textContent=e.name,document.getElementById("groupDetailDescription").textContent=e.description||"暂无描述";const d=document.getElementById("groupDetailAvatar");e.avatar_url?d.src=e.avatar_url:d.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e.name)}&background=667eea&color=fff`;const l=document.querySelector("#groupDetailModal .btn-primary"),u=document.querySelector("#groupDetailModal .btn-secondary");if(s?(l.style.display="none",u.style.display="inline-block",u.onclick=()=>Je(t)):e.is_private?(l.style.display="none",u.style.display="none"):(l.style.display="inline-block",u.style.display="none",l.textContent="申请加入",l.onclick=()=>Qe(t,e)),a)await Pr(t);else{const c=document.getElementById("groupRecentInspirations");c.innerHTML='<div class="empty-state"><p>这是私有小组，只有成员可以查看内容</p></div>'}document.getElementById("groupDetailModal").classList.remove("hidden")}catch(e){console.error("显示小组详情失败:",e),i("显示小组详情失败","error")}finally{v(!1)}}async function Pr(t){try{const{data:e,error:r}=await h.database.from("inspiration_shares").select(`
                inspirations (
                    id, title, content, tags, category, mood, image_url,
                    created_at, user_id,
                    users (nickname, avatar_url)
                ),
                shared_at
            `).eq("group_id",t).order("shared_at",{ascending:!1}).limit(20);if(r){console.error("加载小组灵感失败:",r);return}const n=document.getElementById("groupRecentInspirations");if(!e||e.length===0){n.innerHTML='<div class="empty-state"><p>小组内还没有分享的灵感</p></div>';return}n.innerHTML=e.map(o=>{const s=o.inspirations,a=s.users,d=new Date(o.shared_at).toLocaleDateString();return`
                <div class="inspiration-card group-post" onclick="showInspirationDetail('${s.id}')">
                    <div class="post-header">
                        <div class="user-info">
                            <img class="user-avatar" src="${a.avatar_url||`https://ui-avatars.com/api/?name=${encodeURIComponent(a.nickname||"User")}&background=667eea&color=fff`}" alt="${a.nickname}">
                            <div>
                                <div class="user-name">${g(a.nickname||"Unknown")}</div>
                                <div class="post-date">分享于 ${d}</div>
                            </div>
                        </div>
                    </div>
                    <div class="inspiration-content">
                        <h4>${g(s.title)}</h4>
                        <p>${g(s.content)}</p>
                        ${s.image_url?`<img src="${s.image_url}" alt="灵感图片" class="inspiration-image">`:""}
                        <div class="inspiration-meta">
                            <span class="category">${s.category}</span>
                            <span class="mood">${s.mood}</span>
                            <span class="date">${new Date(s.created_at).toLocaleDateString()}</span>
                        </div>
                    </div>
                </div>
            `}).join("")}catch(e){console.error("加载小组帖子失败:",e)}}async function Je(t){try{const{error:e}=await h.database.from("group_members").delete().eq("group_id",t).eq("user_id",m.user.id);if(e){i("退出小组失败","error");return}const{error:r}=await h.database.from("groups").update({member_count:h.database.raw("member_count - 1")}).eq("id",t);i("已退出小组","success"),await se(),document.getElementById("groupDetailModal").classList.add("hidden")}catch(e){console.error("退出小组失败:",e),i("退出小组失败","error")}}function Lr(){document.getElementById("groupDetailModal").classList.add("hidden")}let Z=null;function Qe(t,e){Z={id:t,data:e},document.getElementById("applyGroupName").textContent=e.name,document.getElementById("applyGroupDescription").textContent=e.description||"暂无描述";const r=document.getElementById("applyGroupAvatar");e.avatar_url?r.src=e.avatar_url:r.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(e.name)}&background=667eea&color=fff`;const n=e.member_count||1;let o;n<40?o=`小组现有 ${n} 名成员，需要超过一半成员（${Math.ceil(n/2)} 票）同意您的申请。`:o=`小组现有 ${n} 名成员，需要超过三分之一成员（${Math.ceil(n/3)} 票）同意您的申请。`,document.getElementById("votingRequirement").textContent=o,document.getElementById("applicationMessage").value="",document.getElementById("applyGroupModal").classList.remove("hidden")}function Ke(){document.getElementById("applyGroupModal").classList.add("hidden"),Z=null}async function Tr(t){var r;if(t.preventDefault(),!Z||!((r=m==null?void 0:m.user)!=null&&r.id)){i("申请失败","error");return}const e=document.getElementById("applicationMessage").value.trim();if(!e){i("请填写申请理由","error");return}try{v(!0);const{data:n,error:o}=await h.functions.invoke("apply-to-group",{body:{group_id:Z.id,message:e}});if(o){console.error("申请提交失败:",o),i(o.message||"申请提交失败","error");return}i(n.message||"申请已提交，等待小组成员投票","success"),Ke(),document.getElementById("applicationMessage").value=""}catch(n){console.error("申请提交失败:",n),i("申请提交失败","error")}finally{v(!1)}}let _e=null;function Sr(t){Mr(t)}function We(){document.getElementById("voteNotificationModal").classList.add("hidden"),_e=null}async function Mr(t){try{v(!0);const{data:e,error:r}=await h.database.from("group_applications").select(`
                *,
                users!group_applications_applicant_id_fkey(nickname, avatar_url),
                groups(name)
            `).eq("id",t).single();if(r){console.error("获取申请详情失败:",r),i("加载申请信息失败","error");return}_e=e;const n=e.users;document.getElementById("applicantName").textContent=n.nickname||"Unknown",document.getElementById("applicationDate").textContent=new Date(e.created_at).toLocaleDateString(),document.getElementById("voteApplicationMessage").textContent=e.message;const o=document.getElementById("applicantAvatar");n.avatar_url?o.src=n.avatar_url:o.src=`https://ui-avatars.com/api/?name=${encodeURIComponent(n.nickname||"User")}&background=667eea&color=fff`;const s=e.votes_received/e.votes_needed*100;document.getElementById("voteProgressBar").style.width=`${s}%`,document.getElementById("voteStatusText").textContent=`投票进度: ${e.votes_received}/${e.votes_needed}`;const{data:a,error:d}=await h.database.from("group_application_votes").select("vote").eq("application_id",t).eq("voter_id",m.user.id).single(),l=document.getElementById("approveVoteBtn"),u=document.getElementById("rejectVoteBtn");a&&!d?a.vote?(l.textContent="✓ 已同意",l.disabled=!0,u.disabled=!0):(u.textContent="✗ 已拒绝",l.disabled=!0,u.disabled=!0):(l.textContent="同意加入",u.textContent="拒绝申请",l.disabled=!1,u.disabled=!1,l.onclick=()=>O(t,!0),u.onclick=()=>O(t,!1)),document.getElementById("voteNotificationModal").classList.remove("hidden")}catch(e){console.error("加载申请投票失败:",e),i("加载申请信息失败","error")}finally{v(!1)}}async function O(t,e){try{v(!0);const{data:r,error:n}=await h.functions.invoke("submit-vote",{body:{application_id:t,vote:e}});if(n){console.error("投票失败:",n),i(n.message||"投票失败","error");return}i(r.message||(e?"已投赞成票":"已投反对票"),"success"),r.application_approved&&setTimeout(()=>{i("申请已通过，申请人已自动加入小组！","success")},1500),We()}catch(r){console.error("投票失败:",r),i("投票失败","error")}finally{v(!1)}}function Xe(t){var p,y,w;_e=t;const e=document.getElementById("voteNotificationModal"),r=document.getElementById("applicantName"),n=document.getElementById("applicantAvatar"),o=document.getElementById("voteApplicationMessage"),s=document.getElementById("applicationDate"),a=document.getElementById("applicationExpiry"),d=document.getElementById("voteProgressBar"),l=document.getElementById("voteStatusText"),u=document.getElementById("approveVoteBtn"),c=document.getElementById("rejectVoteBtn");if(r&&(r.textContent=((p=t.users)==null?void 0:p.nickname)||"未知用户"),n&&(n.src=((y=t.users)==null?void 0:y.avatar_url)||`https://api.dicebear.com/7.x/avataaars/svg?seed=${((w=t.users)==null?void 0:w.nickname)||"user"}`),o&&(o.textContent=t.message||"无申请消息"),s&&(s.textContent=new Date(t.created_at).toLocaleDateString()),a){const E=new Date(t.expires_at),k=Math.ceil((E-new Date)/(1e3*60*60*24));k>0?(a.textContent=`${E.toLocaleDateString()} (还剩${k}天)`,a.style.color=k<=3?"#ef4444":"#6b7280"):(a.textContent=`${E.toLocaleDateString()} (已过期)`,a.style.color="#ef4444")}if(d&&l){const E=t.votes_received/t.votes_needed*100;d.style.width=`${Math.min(E,100)}%`,l.textContent=`投票进度: ${t.votes_received}/${t.votes_needed}`}u&&c&&(u.disabled=!1,c.disabled=!1,u.onclick=null,c.onclick=null,u.onclick=()=>O(t.id,!0),c.onclick=()=>O(t.id,!1)),e.classList.remove("hidden")}function Ye(){document.getElementById("createGroupModal").classList.remove("hidden")}function Ze(){document.getElementById("createGroupModal").classList.add("hidden"),document.getElementById("createGroupForm").reset()}async function Ar(t){t.preventDefault();const e=document.getElementById("groupName").value,r=document.getElementById("groupDescription").value,n=document.getElementById("isPrivateGroup").checked,o=parseInt(document.getElementById("maxMembers").value);try{v(!0);const{data:s,error:a}=await h.database.from("groups").insert([{name:e,description:r,creator_id:m.user.id,is_private:n,max_members:o,member_count:1}]).select().single();if(a){i("创建小组失败","error");return}const{error:d}=await h.database.from("group_members").insert([{group_id:s.id,user_id:m.user.id,role:"creator"}]);d&&console.error("加入创建者失败:",d),i("小组创建成功","success"),Ze(),A==="groups"&&await se()}catch(s){console.error("Create group error:",s),i("创建小组失败","error")}finally{v(!1)}}function Cr(){console.log("User search functionality - to be implemented"),i("用户搜索功能待实现","info")}function Rr(){console.log("Follow user functionality - to be implemented"),i("关注用户功能待实现","info")}function xr(){console.log("Join group functionality - to be implemented"),i("加入小组功能待实现","info")}function Dr(){console.log("Leave group functionality - to be implemented"),i("离开小组功能待实现","info")}function et(t){W=t,Or(),document.getElementById("shareToGroupModal").classList.remove("hidden")}function tt(){document.getElementById("shareToGroupModal").classList.add("hidden"),W=null,T=[]}async function Or(){try{const{data:t,error:e}=await h.database.from("group_members").select(`
                groups (id, name, description, avatar_url)
            `).eq("user_id",m.user.id);if(e){console.error("加载用户小组失败:",e);return}const r=(t==null?void 0:t.map(n=>n.groups))||[];jr(r)}catch(t){console.error("Error loading user groups:",t)}}function jr(t){const e=document.getElementById("groupSelectionList");if(e){if(t.length===0){e.innerHTML='<div class="empty-state"><p>你还没有加入任何小组</p></div>';return}e.innerHTML=t.map(r=>`
        <div class="group-selection-item" onclick="toggleGroupSelection('${r.id}')">
            <input type="checkbox" id="group_${r.id}" onchange="toggleGroupSelection('${r.id}')">
            <div class="group-selection-avatar">${r.avatar_url?`<img src="${r.avatar_url}" alt="${r.name}">`:r.name.charAt(0)}</div>
            <div class="group-selection-info">
                <h4>${g(r.name)}</h4>
                <p>${g(r.description||"")}</p>
            </div>
        </div>
    `).join("")}}function qr(t){const e=document.getElementById(`group_${t}`),r=e.closest(".group-selection-item");e.checked?(T.includes(t)||T.push(t),r.classList.add("selected")):(T=T.filter(n=>n!==t),r.classList.remove("selected"))}async function Gr(){if(!W||T.length===0){i("请选择要分享到的小组","error");return}try{v(!0);const t=T.map(e=>h.database.from("inspiration_shares").insert([{inspiration_id:W.id,group_id:e,shared_by:m.user.id}]));await Promise.all(t),i(`成功分享到 ${T.length} 个小组`,"success"),tt()}catch(t){console.error("Share inspiration error:",t),i("分享失败","error")}finally{v(!1)}}function Ur(){pr(),typeof lucide<"u"&&lucide.createIcons(),A==="personal"&&S()}window.showInspirationModal=ge;window.hideInspirationModal=oe;window.hideDetailModal=Y;window.hideToast=ze;window.showCreateGroupModal=Ye;window.hideCreateGroupModal=Ze;window.hideGroupDetailModal=Lr;window.showApplyGroupModal=Qe;window.hideApplyGroupModal=Ke;window.showVoteNotificationModal=Sr;window.hideVoteNotificationModal=We;window.showVoteApplicationModal=Xe;window.submitVote=O;window.showShareToGroupModal=et;window.hideShareToGroupModal=tt;window.showInspirationDetail=ye;window.showUserDetail=function(t){};window.showGroupDetail=Br;window.followUser=$r;window.unfollowUser=kr;window.joinGroup=Ir;window.leaveGroup=Je;window.toggleGroupSelection=qr;window.switchTab=D;window.saveInspiration=Ge;window.cancelEdit=oe;window.editInspiration=Ue;window.deleteInspiration=Ne;window.toggleFavorite=Fe;window.showDetail=ye;window.showReplyForm=mr;window.deleteComment=hr;function Nr(){document.getElementById("langMenu").classList.toggle("hidden")}function Fr(t){window.i18n&&(window.i18n.setLanguage(t),be(),document.getElementById("langMenu").classList.add("hidden"))}function be(){const t=window.i18n?window.i18n.getCurrentLang():"zh",e=document.getElementById("currentLangDisplay");e&&(e.textContent=t==="zh"?"中文":"EN");const r=document.getElementById("loginCurrentLangDisplay");r&&(r.textContent=t==="zh"?"中文":"EN"),document.querySelectorAll(".lang-option").forEach(n=>{n.classList.remove("active"),n.onclick.toString().includes(`'${t}'`)&&n.classList.add("active")})}function Hr(t){window.i18n&&(window.i18n.setLanguage(t),be(),document.getElementById("loginLangMenu").classList.add("hidden"))}document.addEventListener("click",t=>{const e=document.querySelector(".language-switcher"),r=document.getElementById("langMenu");e&&!e.contains(t.target)&&r&&r.classList.add("hidden")});window.addEventListener("languageChanged",t=>{t.detail.language,typeof X=="function"&&X(),typeof renderGroups=="function"&&renderGroups(),typeof renderNotifications=="function"&&renderNotifications(),window.lucide&&lucide.createIcons()});window.showLogin=Jt;window.showRegister=Qt;window.scrollToFeatures=Kt;window.toggleLanguageMenu=Nr;window.changeLanguage=Fr;window.changeLanguageInLogin=Hr;window.markNotificationAsRead=rt;window.deleteNotification=Qr;window.filterNotifications=nt;window.handleNotificationClick=Jr;async function ue(){try{document.getElementById("notificationsLoading").classList.remove("hidden"),document.getElementById("notificationsEmpty").classList.add("hidden");const{data:t,error:e}=await h.database.from("notifications").select(`
                *,
                sender:users!notifications_sender_id_fkey(nickname, avatar_url),
                inspiration:inspirations(title)
            `).eq("recipient_id",m.user.id).order("created_at",{ascending:!1}).limit(50);if(e){console.error("Error loading notifications:",e),i("加载通知失败");return}b=t||[],I=b.filter(r=>!r.is_read).length,U(),R()}catch(t){console.error("Error loading notifications:",t),i("加载通知失败")}finally{document.getElementById("notificationsLoading").classList.add("hidden")}}function U(){const t=document.getElementById("unreadNotificationCount");I>0?(t.textContent=I>99?"99+":I,t.classList.remove("hidden")):t.classList.add("hidden")}function R(){const t=document.getElementById("notificationsList"),e=document.getElementById("notificationsEmpty");let r=b;if(V==="unread"?r=b.filter(o=>!o.is_read):V!=="all"&&(r=b.filter(o=>o.type===V)),r.length===0){t.innerHTML="",e.classList.remove("hidden");return}e.classList.add("hidden");const n=r.map(o=>{var l,u;const s=((l=o.sender)==null?void 0:l.nickname)||"某位用户";(u=o.sender)!=null&&u.avatar_url||`${s}`;const a=zr(o.type),d=Vr(o.type);return`
            <div class="notification-item ${o.is_read?"":"unread"}"
                 data-type="${o.type}"
                 data-notification-id="${o.id}"
                 onclick="handleNotificationClick('${o.id}')">
                <div class="notification-header">
                    <div class="notification-type">
                        <i data-lucide="${a}" class="notification-type-icon"></i>
                        <span>${d}</span>
                    </div>
                    <span class="notification-time">${G(o.created_at)}</span>
                </div>
                <div class="notification-title">${g(o.title)}</div>
                <div class="notification-message">${g(o.message)}</div>
                <div class="notification-actions-item">
                    ${o.is_read?"":`
                        <button class="notification-action-btn" onclick="event.stopPropagation(); markNotificationAsRead('${o.id}')">
                            <i data-lucide="check"></i> 标记已读
                        </button>
                    `}
                    <button class="notification-action-btn" onclick="event.stopPropagation(); deleteNotification('${o.id}')">
                        <i data-lucide="trash-2"></i> 删除
                    </button>
                </div>
            </div>
        `}).join("");t.innerHTML=n,lucide.createIcons()}function zr(t){return{like:"heart",comment:"message-circle",reply:"reply",follow:"user-plus",group_invitation:"users",group_application:"user-check",group_approval:"check-circle"}[t]||"bell"}function Vr(t){return{like:"点赞",comment:"评论",reply:"回复",follow:"关注",group_invitation:"小组邀请",group_application:"入组申请",group_approval:"申请通过"}[t]||"通知"}async function Jr(t){const e=b.find(r=>r.id===t);if(e)if(e.is_read||await rt(t),e.type==="group_application")try{const r=e.message.match(/"([^"]+)"/),n=r?r[1]:null;if(n){const{data:o,error:s}=await h.database.from("group_applications").select(`
                        *,
                        groups!inner(name, description, avatar_url),
                        users(nickname, avatar_url)
                    `).eq("groups.name",n).eq("status","pending").eq("applicant_id",e.sender_id);if(s){console.error("Error fetching application:",s),i("获取申请信息失败","error");return}o&&o.length>0?Xe(o[0]):i("申请不存在或已处理","info")}else i("无法解析申请信息","error")}catch(r){console.error("Error handling group application notification:",r),i("处理申请通知时出错","error")}else e.type==="group_approval"?e.related_group_id&&D("groups"):e.related_inspiration_id&&(D("personal"),setTimeout(()=>{ye(e.related_inspiration_id)},100))}async function rt(t){try{const{error:e}=await h.database.from("notifications").update({is_read:!0}).eq("id",t).eq("recipient_id",m.user.id);if(e){console.error("Error marking notification as read:",e);return}const r=b.find(n=>n.id===t);r&&!r.is_read&&(r.is_read=!0,I--,U(),R())}catch(e){console.error("Error marking notification as read:",e)}}async function Qr(t){if(confirm("确定要删除这条通知吗？"))try{const{error:e}=await h.database.from("notifications").delete().eq("id",t).eq("recipient_id",m.user.id);if(e){console.error("Error deleting notification:",e),i("删除通知失败");return}const r=b.findIndex(n=>n.id===t);r!==-1&&(b[r].is_read||I--,b.splice(r,1),U(),R()),i("通知已删除")}catch(e){console.error("Error deleting notification:",e),i("删除通知失败")}}function nt(t){V=t,document.querySelectorAll(".filter-btn").forEach(e=>{e.classList.remove("active")}),document.querySelector(`[data-filter="${t}"]`).classList.add("active"),R()}async function Kr(){if(I===0){i("没有未读通知");return}try{const t=b.filter(r=>!r.is_read).map(r=>r.id),{error:e}=await h.database.from("notifications").update({is_read:!0}).in("id",t).eq("recipient_id",m.user.id);if(e){console.error("Error marking all notifications as read:",e),i("标记已读失败");return}b.forEach(r=>{r.is_read||(r.is_read=!0)}),I=0,U(),R(),i("所有通知已标记为已读")}catch(t){console.error("Error marking all notifications as read:",t),i("标记已读失败")}}async function Wr(){if(b.length===0){i("没有通知可清除");return}if(confirm("确定要清空所有通知吗？此操作不可撤销。"))try{const{error:t}=await h.database.from("notifications").delete().eq("recipient_id",m.user.id);if(t){console.error("Error clearing all notifications:",t),i("清空通知失败");return}b=[],I=0,U(),R(),i("所有通知已清空")}catch(t){console.error("Error clearing all notifications:",t),i("清空通知失败")}}function Pe(){ue(),document.querySelectorAll(".filter-btn").forEach(t=>{t.addEventListener("click",()=>{nt(t.dataset.filter)})}),document.getElementById("markAllReadBtn").addEventListener("click",Kr),document.getElementById("clearAllNotificationsBtn").addEventListener("click",Wr)}function Xr(){console.log("Starting periodic cleanup for expired applications"),Le(),setInterval(()=>{console.log("Running periodic cleanup of expired applications"),Le()},24*60*60*1e3)}async function Le(){try{const{data:t,error:e}=await h.functions.invoke("cleanup-expired-applications");if(e){console.error("Error cleaning up expired applications:",e);return}t&&t.expired_count>0?(console.log(`Successfully cleaned up ${t.expired_count} expired applications`),typeof ue=="function"&&ue()):console.log("No expired applications found to clean up")}catch(t){console.error("Failed to cleanup expired applications:",t)}}
